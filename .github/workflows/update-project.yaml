name: Update Project Backlog

on:
  schedule:
    - cron: "0 */6 * * *" # 每 6 小时
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Project Data
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          node <<'EOF'
          const fs = require("fs");
          const fetch = global.fetch;

          const query = `
          query {
            user(login: "Moemu") {
              projectV2(number: 4) {
                items(first: 20) {
                  nodes {
                    content {
                      ... on Issue {
                        title
                        url
                        updatedAt
                      }
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field { name }
                        }
                      }
                    }
                  }
                }
              }
            }
          }`;

          async function run() {
            const res = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.GH_TOKEN}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ query })
            });
            const json = await res.json();

            const items = json.data.user.projectV2.items.nodes;

            let table = `| 项目 | 状态 | 最后更新 |\n|---|---|---|\n`;

            for (const item of items) {
              if (!item.content) continue;

              const status = item.fieldValues.nodes.find(
                f => f.field?.name === "Status"
              )?.name || "—";

              table += `| [${item.content.title}](${item.content.url}) | ${status} | ${item.content.updatedAt.slice(0,10)} |\n`;
            }

            const readme = fs.readFileSync("README.md", "utf8");
            const updated = readme.replace(
              /<!-- PROJECTS:START -->([\s\S]*?)<!-- PROJECTS:END -->/,
              `<!-- PROJECTS:START -->\n${table}\n<!-- PROJECTS:END -->`
            );

            fs.writeFileSync("README.md", updated);
          }

          run();
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -am "chore: update project backlog" || exit 0
          git push