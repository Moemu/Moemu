name: Update Project Backlog

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Project Data
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          node <<'EOF'
          const fs = require("fs");

          const query = `
          query {
            user(login: "Moemu") {
              projectV2(number: 4) {
                items(first: 20) {
                  nodes {
                    content {
                      ... on Issue {
                        title
                        url
                        updatedAt
                      }
                      ... on PullRequest {
                        title
                        url
                        updatedAt
                      }
                      ... on ProjectV2ItemDraftIssue {
                        title
                        updatedAt # Drafts also have this, but inside the draft fragment
                      }
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2Field { name }
                            ... on ProjectV2IterationField { name }
                            ... on ProjectV2SingleSelectField { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }`;

          async function run() {
            const res = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.GH_TOKEN}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ query })
            });
            
            const json = await res.json();
            
            if (json.errors) {
              console.error("GraphQL Errors:", JSON.stringify(json.errors, null, 2));
              process.exit(1);
            }

            const items = json.data?.user?.projectV2?.items?.nodes || [];
            let table = `| 项目 | 状态 | 最后更新 |\n|---|---|---|\n`;

            for (const item of items) {
              // If item.content is null (common with Drafts or restricted items), skip it
              if (!item.content) continue;

              const statusNode = item.fieldValues.nodes.find(node => 
                node.field?.name === "Status"
              );
              
              const status = statusNode ? statusNode.name : "—";
              const title = item.content.title || "Untitled";
              const url = item.content.url || "#";
              
              // Safe check for updatedAt
              const updated = item.content.updatedAt 
                ? item.content.updatedAt.slice(0, 10) 
                : "—";

              table += `| [${title}](${url}) | ${status} | ${updated} |\n`;
            }

            const readmePath = "README.md";
            if (fs.existsSync(readmePath)) {
              const readme = fs.readFileSync(readmePath, "utf8");
              const updatedReadme = readme.replace(
                /([\s\S]*?)/,
                `\n${table}\n`
              );
              fs.writeFileSync(readmePath, updatedReadme);
            }
          }

          run().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "chore: update project backlog" || exit 0
          git push