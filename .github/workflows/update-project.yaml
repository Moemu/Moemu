name: Update Project Backlog

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Project Data
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          node <<'EOF'
          const fs = require("fs");

          const query = `
          query {
            user(login: "Moemu") {
              projectV2(number: 4) {
                url
                items(first: 20) {
                  nodes {
                    updatedAt # å…³é”®ï¼šçœ‹æ¿æ¡ç›®çš„æœ€åå˜åŠ¨æ—¶é—´
                    content {
                      __typename
                      ... on DraftIssue { title }
                      ... on Issue { title url }
                      ... on PullRequest { title url }
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2Field { name }
                            ... on ProjectV2SingleSelectField { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }`;

          async function run() {
            const res = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.GH_TOKEN}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ query })
            });
            
            const json = await res.json();
            
            if (json.errors) {
              console.error("GraphQL Errors:", JSON.stringify(json.errors, null, 2));
              process.exit(1);
            }

              const projectUrl = json.data?.user?.projectV2?.url || "#";
              const items = json.data?.user?.projectV2?.items?.nodes || [];
              
              // æ„å»º Markdown è¡¨æ ¼
              let table = `| Project | Status | Last Updated |\n|---|---|---|\n`;

              for (const item of items) {
                const content = item.content;
                if (!content) continue;

                // 1. æå–çŠ¶æ€ (Status)
                const statusNode = item.fieldValues.nodes.find(n => n.field?.name === "Status");
                let status = statusNode ? statusNode.name : "â€”";

                if (status == "Public archive") { status = "ğŸ”´Public archive"; }
                else if (status == "Maintenance mode") { status = "ğŸŸ¡Maintenance mode"; }
                else if (status == "In development") { status = "ğŸŸ¢In development"; }

                // 2. æ ‡é¢˜ä¸é“¾æ¥ (å¦‚æœæ˜¯ Draft åˆ™è·³è½¬åˆ°çœ‹æ¿)
                const title = content.title || "Untitled";

                // 3. æ—¥æœŸ (ä¼˜å…ˆçœ‹æ¿æ›´æ–°æ—¶é—´)
                const rawDate = item.updatedAt || "";
                const updated = rawDate ? rawDate.slice(0, 10) : "â€”";

                table += `| ${title} | ${status} | ${updated} |\n`;
              }

            const readmePath = "README.md";
            if (fs.existsSync(readmePath)) {
              const readme = fs.readFileSync(readmePath, "utf8");
              const regex = /<!-- PROJECTS:START -->[\s\S]*?<!-- PROJECTS:END -->/i;
              const newContent = `<!-- PROJECTS:START -->\n${table}<!-- PROJECTS:END -->\n`;
              if (regex.test(readme)) {
                console.log("æ‰¾åˆ°åŒ¹é…æ ‡ç­¾ï¼Œæ­£åœ¨æ›´æ–°å†…å®¹...");
                const updatedReadme = readme.replace(regex, newContent);
                fs.writeFileSync(readmePath, updatedReadme);
              } else {
                console.error("é”™è¯¯ï¼šåœ¨ README.md ä¸­æ‰¾ä¸åˆ°<!-- PROJECTS:START -->å’Œ<!-- PROJECTS:END -->æ ‡ç­¾ï¼");
                process.exit(0);
              }
            }
          }

          run().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "chore: update project backlog" || exit 0
          git push