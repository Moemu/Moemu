name: Update Project Backlog

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Project Data
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          node <<'EOF'
          const fs = require("fs");

          const query = `
          query {
            user(login: "Moemu") {
              projectV2(number: 4) {
                url
                items(first: 20) {
                  nodes {
                    updatedAt # 关键：看板条目的最后变动时间
                    content {
                      __typename
                      ... on DraftIssue { title }
                      ... on Issue { title url }
                      ... on PullRequest { title url }
                    }
                    fieldValues(first: 10) {
                      nodes {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field {
                            ... on ProjectV2Field { name }
                            ... on ProjectV2SingleSelectField { name }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }`;

          async function run() {
            const res = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.GH_TOKEN}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ query })
            });
            
            const json = await res.json();
            
            if (json.errors) {
              console.error("GraphQL Errors:", JSON.stringify(json.errors, null, 2));
              process.exit(1);
            }

              const projectUrl = json.data?.user?.projectV2?.url || "#";
              const items = json.data?.user?.projectV2?.items?.nodes || [];
              
              // 构建 Markdown 表格
              let table = `| 项目 | 状态 | 最后更新 |\n|---|---|---|\n`;

              for (const item of items) {
                const content = item.content;
                if (!content) continue;

                // 1. 提取状态 (Status)
                const statusNode = item.fieldValues.nodes.find(n => n.field?.name === "Status");
                const status = statusNode ? statusNode.name : "—";

                // 2. 标题与链接 (如果是 Draft 则跳转到看板)
                const title = content.title || "Untitled";
                const url = content.url || projectUrl;

                // 3. 日期 (优先看板更新时间)
                const rawDate = item.updatedAt || "";
                const updated = rawDate ? rawDate.slice(0, 10) : "—";

                table += `| [${title}](${url}) | ${status} | ${updated} |\n`;
              }

            const readmePath = "README.md";
            if (fs.existsSync(readmePath)) {
              const readme = fs.readFileSync(readmePath, "utf8");
              const regex = /<!-- PROJECTS:START -->[\s\S]*?<!-- PROJECTS:END -->/i;
              const newContent = `<!-- PROJECTS:START -->\n${table}<!-- PROJECTS:END -->\n`;
              if (regex.test(readme)) {
                console.log("找到匹配标签，正在更新内容...");
                const updatedReadme = readme.replace(regex, newContent);
                fs.writeFileSync(readmePath, updatedReadme);
              } else {
                console.error("错误：在 README.md 中找不到<!-- PROJECTS:START -->和<!-- PROJECTS:END -->标签！");
                process.exit(0);
              }
            }
          }

          run().catch(err => {
            console.error(err);
            process.exit(1);
          });
          EOF

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "chore: update project backlog" || exit 0
          git push